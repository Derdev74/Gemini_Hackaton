version: '3.8'

# ═══════════════════════════════════════════════════════════════
# Just Travel - Full Stack Docker Compose
# ═══════════════════════════════════════════════════════════════
# Services:
#   - backend:  FastAPI + AI Agents (Python 3.12)
#   - frontend: Next.js 14 PWA (Node 20)
#   - redis:    Background task storage (Redis 7)

services:
  # ─────────────────────────────────────────────────────────────
  # Backend Service (FastAPI + AI Agents)
  # ─────────────────────────────────────────────────────────────
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: just-travel-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # API Keys (set in .env file)
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY:-}
      - NEO4J_URI=${NEO4J_URI:-}
      - NEO4J_USERNAME=${NEO4J_USERNAME:-}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-}
      - APIFY_API_TOKEN=${APIFY_API_TOKEN:-}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY:-}
      - AMADEUS_CLIENT_ID=${AMADEUS_CLIENT_ID:-}
      - AMADEUS_CLIENT_SECRET=${AMADEUS_CLIENT_SECRET:-}

      # Auth Settings
      - SECRET_KEY=${SECRET_KEY:-your-secret-key-change-in-production}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=15
      - REFRESH_TOKEN_EXPIRE_DAYS=7

      # Google OAuth
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}

      # Redis Configuration (for PWA background tasks)
      - REDIS_URL=redis://redis:6379/0
      - USE_CELERY=false

      # Database
      - DATABASE_FILE=/app/data/just_travel.db

      # CORS
      - FRONTEND_URL=http://localhost:3000
    volumes:
      # Persist SQLite database
      - ./data:/app/data
      # Mount uploads directory
      - ./uploads:/app/uploads
    networks:
      - just-travel-network
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ─────────────────────────────────────────────────────────────
  # Frontend Service (Next.js 14 PWA)
  # ─────────────────────────────────────────────────────────────
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: just-travel-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Backend API URL (internal Docker network)
      - NEXT_PUBLIC_API_URL=http://backend:8000

      # NextAuth Configuration
      - NEXTAUTH_URL=http://localhost:3000
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-your-nextauth-secret-change-in-production}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}

      # Production settings
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    networks:
      - just-travel-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ─────────────────────────────────────────────────────────────
  # Redis Service (PWA Background Tasks)
  # ─────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: just-travel-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      # Persist Redis data
      - redis-data:/data
    networks:
      - just-travel-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

# ─────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────
networks:
  just-travel-network:
    driver: bridge
    name: just-travel-network

# ─────────────────────────────────────────────────────────────
# Volumes (Persistent Storage)
# ─────────────────────────────────────────────────────────────
volumes:
  redis-data:
    driver: local
    name: just-travel-redis-data
